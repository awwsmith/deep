{% extends 'base.html' %}
{% load static %}
{% block content %}

<!-- ======= Search Section ======= -->
<section id="search" class="services section-bg">
  <div style="margin-top:80px; min-height: 600px;" class="container" >
    <div id="users">

    <div class="row">
      <div class="col-lg-12 col-md-12">
        <div class="icon-box">
          <div class="icon"><i class="bi bi-search" style="color: #330e40;" no-repeat center center fixed;"></i></div>
         
  
          <input id="search_bar" style="margin-left:10px; width:100%" type="text" name="search" placeholder="Search for a playbook...">
        
        </div>
      </div>
      
      
  </div>
  

  <div  class="row">
    <div class="col-lg-12 col-md-12">
    
      <!-- View Selector  -->
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="inlineRadioOptions" id="titleRadio" value="title">
        <label class="form-check-label text-light" for="titleRadio">Title</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="inlineRadioOptions" id="editionRadio" value="edition" checked>
        <label class="form-check-label text-light" for="editionRadio">Edition</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="inlineRadioOptions" id="recordRadio" value="record">
        <label class="form-check-label text-light" for="recordRadio">Record</label>
      </div>

      <button id="expandAllButton" class="btn btn-light float-end" onclick="expandAll(this);">Expand all</button>
  <table class="table bg-light text-dark rounded-0">
    <!-- IMPORTANT, class="list" have to be at tbody -->
    <tbody class="list">
      <thead>
        <tr>
          
          <th class="sort col-2" data-sort="year" scope="col">Year</th>
          <th class="sort col-2" data-sort="author" scope="col">Author</th>
          <th class="sort col-7" data-sort="title" scope="col">Title</th>
          <th class="col-1"></th>
        </tr>
      </thead>
      

    </tbody>

  </table>
  

</div>


      
    </div>
    
</div>
</section><!-- End Search Section -->

  
  
{% endblock %}    
    

  
  {% block extra_js %}  
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>    

 <script>

// fetch data for all records
let item_data;
fetch("../assets/data/item_data.json").then(
        function(u){ return u.json();}
      ).then(
        function(json){
          item_data = json;
        });
        
let index;
fetch("../assets/lunr/search.json").then(
        function(u){ return u.json();}
      ).then(
        function(json){
          index = lunr.Index.load(json);
        });
        
//listen for search_bar
let options = {
      valueNames: ['title', 'year', 'greg_full' ],
      
      // Since there are no elements in the list, this will be used as template.
      item: function(values) { 
        return `<tr id="${values.id}" onclick="expand(this, ${values.id});"><td class="year"></td><td class="author"></td><td class="title"></td><td>Expand</td></tr>`
      }
    };
let table = new List('users', options, []);

// temporary until groupBy is added to JS
let groupBy = function(xs, key) {
  return xs.reduce(function(rv, x) {
    (rv[x[key]] = rv[x[key]] || []).push(x);
    return rv;
  }, {});
};

function search() {
  table.clear();
  let query = document.querySelector('#search_bar').value;
  query += '~1' //fuzzy search,  1 edit distance
    
  search_results = index.search(query)
  results = []
  // logic for title-edition-record filtering 
  let filter = radioHelper();
  if (filter == 'title') {
    search_results.forEach(function(result) {
      results.push(item_data[result.ref])
    });
    let groups = groupBy(results, 'greg');
    
    results = []
    for (i in groups) {
      if (groups[i].length == 1) {
        results.push(groups[i][0])
      } else {
        // sort the group by deep_id, return only lowest deep id
        let d = groups[i].sort((a,b) => a.deep_id - b.deep_id);
        results.push(d[0])
      }
    }
  } else if (filter == 'edition') {
    // load data for each result 
    search_results.forEach(function(result) {
      results.push(item_data[result.ref])
    });
    let groups = groupBy(results, 'greg_middle');
    
    results = []
    for (i in groups) {
      if (groups[i].length == 1) {
        results.push(groups[i][0])
      } else {
        // sort the group by deep_id, return only lowest deep id
        let d = groups[i].sort((a,b) => a.deep_id - b.deep_id);
        // TODO add variant data to d 
        results.push(d[0])
      }
      
      
    };
    
  } else if (filter == 'record') {
    search_results.forEach(function(result) {
      results.push(item_data[result.ref])
    });
  }
  
  
  table.add(results);
  table.update();
};

document.querySelector('#search_bar').addEventListener('keyup', function() {
  search();
});
          
        
       
function expand(e, id) {
  let data = item_data[id];
  if (data) {
  e.outerHTML = `
  <tr id="${data.id}" onclick="collapse(this, ${data.id});"><td class="year">${data.year}</td><td class="author">${data.author}</td><td class="title">${data.title}</td><td>Collapse</td>
  
  <tr id="${data.id}-exp">
    <td colspan="5">
      <div class="card" style="width: 100%;">
        
        <div class="card-body">
          <div class="row">
            <div class="col-5">
              <strong>Reference Information</strong>
              <p>DEEP #: ${data.deep_id}<br>
              Greg #: ${data.greg_full}<br>
              STC/WING: ${data.stc}<br>
              Book Edition: ${data.book_edition}<br>
              Play Edition: ${data.play_edition}<br>
              Format: ${data.format}<br>
              Leaves: ${data.leaves}<br>
              Total Editions: ${data.total_editions}<br>
              
            </div>
            
    
            <div class="col-7">
              <p>Record Type: ${data.record_type}<br>
              Play Type: ${data.play_type}<br>
              Genre (Annals): ${data.genre}<br>
              Date of First Publication: ${data.date_first_publication}<br>
              Date of First Performance: ${data.date_first_performance}<br>
              Company of First Performance: ${data.company_first_performance}<br>
              Company Attribution: ${data.company_attribution}</p>
            </div>

          </div>  
         </div>
      </div>

      <div class="card" style="width: 100%; margin-top:2px;">
        <div class="card-body">
          <div class="row">
            <div class="col-12">
              <strong>Title-Page Features</strong>
              <p>
                Title: TODO<br>
                Author: TODO<br>
                Performance: TODO<br>
                Imprint: TODO<br>
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="width: 100%; margin-top:2px;">
        <div class="card-body">
          <div class="row">
            <div class="col-12">
              <strong>Paratextual Material</strong>
              <p>
                Dedication: TODO<br>
                Commendatory Verses: TODO<br>
                To the Reader: TODO<br>
                Errata: TODO<br>
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="width: 100%; margin-top:2px;">
        <div class="card-body">
          <div class="row">
            <div class="col-12">
              <strong>Stationer Information</strong>
              <p>
                Printer: TODO<br>
                Publisher: TODO<br>
                Imprint Location: TODO<br>
                Entries in Stationers' Register: TODO<br>
              </p>
            </div>
          </div>
        </div>
      </div>
    </td>
    
  </tr>`;
  }
}

function collapse(e, id) {
  
    let data = item_data[id];
    if (data) {
      e.outerHTML = `
      <tr id="${data.id}" onclick="expand(this, ${data.id});"><td class="year">${data.year}</td><td class="author">${data.author}</td><td class="title">${data.title}</td><td>Expand</td>`
      let expandCard = document.getElementById(id+'-exp');
      if (expandCard) {
        expandCard.remove();
      }
    }
  }

function expandAll(e) { 
  let items = document.querySelectorAll('tr');
  items.forEach(function(item) {
    expand(item, item.id);
  });
  e.textContent = 'Collapse All';
  e.setAttribute( "onClick", "collapseAll(this)" );
}

function collapseAll(e){
  let items = document.querySelectorAll('tr');
  items.forEach(function(item) {
    if (!item.id.includes("-exp")) {
      collapse(item, item.id);
    }
  });
  e.textContent = 'Expand All';
  e.setAttribute( "onClick", "expandAll(this)" );

};

function radioHelper(){
  if (document.getElementById('titleRadio').checked){
    return 'title';
  }
  else if (document.getElementById('editionRadio').checked){
    return 'edition';
  }
  else if (document.getElementById('recordRadio').checked){
    return 'record';
  }
}

// listen for radio filter changes

document.querySelectorAll('input[type=radio]').forEach(item => {
  item.addEventListener('change', event => {
    search();
  })
})

 </script>
  {% endblock %}
