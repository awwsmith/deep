{% extends 'base.html' %}
{% block content %}

<!-- ======= Search Section ======= -->
<section id="search" class="services section-bg">
  <div style="margin-top:80px;" class="container">

    

    <div class="row">
      <div class="col-lg-12 col-md-12">
        <div class="icon-box">
          <div class="icon"><i class="bi bi-search" style="color: #330e40;"></i></div>
          
            <input id="search_bar" onkeyup="search_bar()" style="margin-left:10px; width:100%" type="text" name="search" placeholder="Search for a playbook...">
        
        </div>
      </div>
      
      
  </div>
  <div class="row">
    <div class="col-lg-4 col-md-6">
      <div class="icon-box">
        <h4 class="title"><a href="">By Title</a></h4>
        <select id="titles" data-placeholder="Select title..." class="form-control select-access-multiple-enable">
      </select>
      </div>
    </div>

    <div class="col-lg-4 col-md-6">
      <div class="icon-box">
        
        <h4 class="title"><a href="">By Author</a></h4>
        <select id="author" data-placeholder="Select author..."  class="form-control select-access-multiple-enable">
        </select>
        </div>
    </div>


    <div class="col-lg-4 col-md-6" data-wow-delay="0.1s">
      <div style="pointer-events: none;" class="icon-box">
        <h4 class="title"><a href="">By Theater</a></h4>
        <select id="theater" data-placeholder="Select theater..."  class="form-control select-access-multiple-enable">
        </select>
        </div>
    </div>

    

    
  </div>

  <div class="row">
    <div class="col-lg-12 col-md-12">
      <div id="results"  class="icon-box">
        
        
      
      </div>
    </div>
    
</div>
</section><!-- End Search Section -->

  
  
{% endblock %}    
    

  
  {% block extra_js %}  
 <script>
// you should get the data from JSON and use it to build option tag to let the normal filter works. 

  $('#titles').select2({
  ajax: {
    {% if build %}
    url: "../assets/data/items.json",
    {% else %}
    url: "{% url 'title_autocomplete' %}",
    {% endif %}

    dataType: 'json'
    // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
  }
});
$('#titles').on('select2:select', function(e) {
    search();
  });
  
$('#author').select2({
  ajax: {
    {% if build %}
    url: "../assets/data/authors.json",
    {% else %}
    url: "{% url 'person_autocomplete' %}",
    {% endif %}
    dataType: 'json'
    // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
  }
});
$('#author').on('select2:select', function(e) {
    search();
  });

$('#theater').select2({
  ajax: {
    {% if build %}
    url: "../assets/data/theater.json",
    {% else %}
    url: "{% url 'theater_autocomplete' %}",
    {% endif %}
    dataType: 'json'
    // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
  }
});
  </script>
  <!-- select2 JS File -->
 <script>

let ItemData;    
fetch("../assets/data/item_data.json").then(
        function(u){ return u.json();}
      ).then(
        function(json){
          ItemData = json;
        }
      )


function htmlToElement(html) {
      var template = document.createElement("template");
      html = html.trim(); // Never return a text node of whitespace as the result
      template.innerHTML = html;
      return template.content.firstChild;
    }

let index;
$.getJSON("../assets/lunr/search.json", function(json) {
  index = lunr.Index.load(json);;
});

function search() {
    // clear existing results 
    existingResults = document.getElementById("results");
    while (existingResults.firstChild) {
      existingResults.removeChild(existingResults.firstChild);
    }
    
    // select values in search and filters 
    let query = '';
    let search_bar_value = document.querySelector('#search_bar').value;
    if (search_bar_value) {
      query += search_bar_value + '~1' //fuzzy search,  1 edit distance
    }
    let titles =  document.querySelector('#titles').value;
    if (!titles.length == 0) { 
      query += ' +id:' + titles;
    }
    let author=  document.querySelector('#author').value;
    if (!author.length == 0) { 
      query += ' +author_id:' + author;
    }
    let theater=  document.querySelector('#theater').value;
    if (!theater.length == 0) { 
      query += ' person_id:' + theater;
    }

    // Lunr query and populate results
    console.log('[query]', query)
    search_results = index.search(query)
    for (i in search_results) {
      if (search_results[i].score > 0) {
        //
        let ref_id = search_results[i].ref;
        let data = ItemData[ref_id];
        console.log(data)
        document
            .querySelector("#results")
            .appendChild(
              htmlToElement(
                `<div onclick="showModal(${search_results[i].ref});" id="${search_results[i].ref}" style="border: 1px inset rgba(95,81,164,0.26); border-radius: 20px; padding:50px;">
                <div class="row">
                  <div class="col-lg-8 col-md-4">
                  <h4>${data['title']}</h4>
                  </div>
                  <div class="col-lg-2">
                  <h6>${data['year']}</h6>
                  </div>
                  <div class="col-lg-2">
                  <h6>${data['greg_full']}</h6>
                  </div>
                </div>
                </div>`
              )
            );

      }
      
    }
   
}; 

function search_bar() {
  // trigger search on enter from search bar
  if (event.keyCode === 13) { 
    search();
  }
}

function showModal(id) {
  let data = ItemData[id];
  console.log(data);
  //document.querySelector('#deepModal').on('show.bs.modal', function (event) {
  // })

}

 </script>
  {% endblock %}
