{% extends 'base.html' %}
{% load static %}
{% block content %}

<!-- ======= Search Section ======= -->
<section id="search" class="services section-bg">
  <div style="margin-top:80px; min-height: 600px;" class="container" >
    <div id="users">

    <div class="row">
      <div class="col-lg-12 col-md-12">
        <div class="icon-box">
          <div class="icon"><i class="bi bi-search" style="color: #330e40;" no-repeat center center fixed;"></i></div>
         
  
          <input id="search_bar" style="margin-left:10px; width:100%" type="text" name="search" placeholder="Search for a playbook...">
        
        </div>
      </div>
      
      
  </div>
  

  <div  class="row">
    <div class="col-lg-12 col-md-12">
    
  <table class="table bg-light text-dark rounded-0">
    <!-- IMPORTANT, class="list" have to be at tbody -->
    <tbody class="list">
      <thead>
        <tr>
          
          <th class="sort col-2" data-sort="year" scope="col">Year</th>
          <th class="sort col-2" data-sort="author" scope="col">Author</th>
          <th class="sort col-8" data-sort="title" scope="col">Title</th>
        </tr>
      </thead>
      

    </tbody>

  </table>
  

</div>


      
    </div>
    
</div>
</section><!-- End Search Section -->

  
  
{% endblock %}    
    

  
  {% block extra_js %}  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>    

 <script>

// fetch data for all records
let item_data;
fetch("../assets/data/item_data.json").then(
        function(u){ return u.json();}
      ).then(
        function(json){
          item_data = json;
        });
        
let index;
fetch("../assets/lunr/search.json").then(
        function(u){ return u.json();}
      ).then(
        function(json){
          index = lunr.Index.load(json);
        });
        
//listen for search_bar
let options = {
      valueNames: ['title', 'year', 'greg_full' ],
      
      // Since there are no elements in the list, this will be used as template.
      item: function(values) { 
        return `<tr onclick="expand(this, ${values.id});"><td class="year"></td><td class="author"></td><td class="title"></td></tr>`
      }
    };
let table = new List('users', options, []);

document.querySelector('#search_bar').addEventListener('keyup', function() {
  table.clear();
  let query = document.querySelector('#search_bar').value;
  query += '~1' //fuzzy search,  1 edit distance
    
  search_results = index.search(query)
  results = []
  for (i in search_results) {
    results.push(item_data[search_results[i].ref]);
  }
  console.log(results)
  
  table.add(results);
  table.update();
});
          
        
       
function expand(e, id) {
  let data = item_data[id];
  e.outerHTML = `
  <tr onclick="collapse(this, ${data.id});"><td class="year">${data.year}</td><td class="author">${data.author}</td><td class="title">${data.title}</td>
  
  <tr>
    <td colspan="5">
      <div class="card" style="width: 100%;">
        
        <div class="card-body">
          <div class="row">
            <div class="col-3">
              <p>DEEP #: ${data.deep_id}</p>
              <p>Greg #: ${data.greg_full}</p>
              <p>STC/Wing #: ${data.stc}</p>
            </div>
            
    
            <div class="col-9">
              <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
            </div>

          </div>  
        </div>

        <div class="card-footer">
         
        </div>
      </div>
    </td>
  </tr>

   
  

    <tr>
     
      <td>
        // year
      </td>
      <td>
        <h3>Reference Information</h3>
                <div>
                    <div><span >DEEP #:</span>
                        <u><a href='1200'>1200</a></u>
                    </div>

                    <div><span>Greg #:</span> L11a</div>
                    <div><span>STC/Wing #:</span> 249 </div>
                </div>
                <div>
                    <div><span>Record Type:</span> Single-Play Playbook</div>
                    <div><span>Play Type:</span> Latin University</div>
                    <div><span>Genre (Annals):</span> Latin Tragedy</div>
                </div>
                <div>
                    <span>Book Edition:</span> 1</div>
                    <div><span>Play Edition:</span> 1</div>
                    <div><span>Format:</span> Duodecimo</div>
                    <div><span>Leaves:</span> 45</div>
                </div>
                <div><span class="label">Total Editions:</span> 1 duodecimo, 1 octavo</div>
                
                <div id="titlepage">
                <h3>Title-Page Features</h3>
                <div class="hanging"><span class="label">Title:</span> ROXANA TRAGÆDIA,</div>
                <div class="hanging"><span class="label">Author:</span> <i>Nunc primum in lucem edita</i>, summáque cum
                    diligentia <i>ad castigatissimum exemplar comparata</i>. Cui accesserunt etiam Argumenta.</div>
                <div class="hanging"><span class="label">Performance:</span> <I>OLIM</I> C<small>ANTABRIGIÆ</small>,
                    Acta in C<small>OL</small>. T<small>RIN</small>.</div>
                <div class="hanging"><span class="label">Imprint:</span> <i>LONDINI</i>, Excudebat <i>R. Badgerus</i>,
                    impensis A<small>NDREÆ</small> C<small>ROOK</small>, <i>ad Signum nigri Vrsi in Cœmiterio</i>
                    P<small>AULINO</small>. 1632.</div>
            </div>
            <div class="stationer">
                <h3>Stationer Information</h3>
                <div><span class="label">Colophon:</span> <i>Excusum Londini, typis</i> R. B. sumptibus <i>Andreæ
                        Crooke,</i> & <i>venum dantur ad signum nigri Vrsi, in Cœmiterio</i> Paulino, MDCXXXII.
                    [<i>var</i>.: "<i>dantur,</i>"] [E6r]</div>
                <div><span class="label">Printer:</span> Badger, Richard (1)</div>
                <div><span class="label">Publisher:</span> Crooke, Andrew (1)</div>
                <div><span class="label">Imprint Location:</span> A.3 (Paul's Churchyard - Northeast)</div>
                <div><span class="label">License:</span> "Imprimatur; primo die Martii Annon Salutis Nostræ Millesimo
                    Sexentesimo [<i>sic</i>] Trigesimo secundo. Per me Henricum Herbert" [E5r]</div>
                <div class="hanging"><span class="label">Entries in Stationers' Register:</span> May 9, 1632: Entered to
                    Andrew Crooke (1): "a Tragedy in Latyn called Roxana &c".</div>
            </div>

      </td>
      
      <td>
        <div class="colright">
                    <div><span class="label">Date of First Publication:</span> 1632</div>
                    <div><span class="label">Date of First Production:</span> 1592 [1590-c.1595]</div>
                    <div><span class="label">Company of First Production:</span> n/a</div>
                    <div style="overflow:auto;"><span class="label">Company Attribution:</span> n/a</div>
                </div>
      </td>
    </tr>
    <tr>
    <td colspan="4">
        <div class="detail" id="detail1" style="display:none;">
            <div class="refinfo">

                <div class="colleft">
                   
                </div>
                <div class="colright">
                    <div><span class="label">Date of First Publication:</span> 1632</div>
                    <div><span class="label">Date of First Production:</span> 1592 [1590-c.1595]</div>
                    <div><span class="label">Company of First Production:</span> n/a</div>
                    <div style="overflow:auto;"><span class="label">Company Attribution:</span> n/a</div>
                </div>

                <div class="break">&nbsp;</div>

                <div><span class="label">Total Editions:</span> 1 duodecimo, 1 octavo</div>





            </div>


            <div class="titlepage">
                <h3>Title-Page Features</h3>
                <div class="hanging"><span class="label">Title:</span> ROXANA TRAGÆDIA,</div>
                <div class="hanging"><span class="label">Author:</span> <i>Nunc primum in lucem edita</i>, summáque cum
                    diligentia <i>ad castigatissimum exemplar comparata</i>. Cui accesserunt etiam Argumenta.</div>
                <div class="hanging"><span class="label">Performance:</span> <I>OLIM</I> C<small>ANTABRIGIÆ</small>,
                    Acta in C<small>OL</small>. T<small>RIN</small>.</div>
                <div class="hanging"><span class="label">Imprint:</span> <i>LONDINI</i>, Excudebat <i>R. Badgerus</i>,
                    impensis A<small>NDREÆ</small> C<small>ROOK</small>, <i>ad Signum nigri Vrsi in Cœmiterio</i>
                    P<small>AULINO</small>. 1632.</div>
            </div>

            <div class="paratext">
                <h3>Paratextual Material</h3>
                <div class="hanging"><span class="label">Character List:</span> "Drammatis Personæ" [A3r]</div>
            </div>

            <div class="stationer">
                <h3>Stationer Information</h3>
                <div><span class="label">Colophon:</span> <i>Excusum Londini, typis</i> R. B. sumptibus <i>Andreæ
                        Crooke,</i> & <i>venum dantur ad signum nigri Vrsi, in Cœmiterio</i> Paulino, MDCXXXII.
                    [<i>var</i>.: "<i>dantur,</i>"] [E6r]</div>
                <div><span class="label">Printer:</span> Badger, Richard (1)</div>
                <div><span class="label">Publisher:</span> Crooke, Andrew (1)</div>
                <div><span class="label">Imprint Location:</span> A.3 (Paul's Churchyard - Northeast)</div>
                <div><span class="label">License:</span> "Imprimatur; primo die Martii Annon Salutis Nostræ Millesimo
                    Sexentesimo [<i>sic</i>] Trigesimo secundo. Per me Henricum Herbert" [E5r]</div>
                <div class="hanging"><span class="label">Entries in Stationers' Register:</span> May 9, 1632: Entered to
                    Andrew Crooke (1): "a Tragedy in Latyn called Roxana &c".</div>
            </div>

        </div>
    </td>
</tr>
  `;
  
}

function htmlToElement(html) {
      var template = document.createElement("template");
      html = html.trim(); // Never return a text node of whitespace as the result
      template.innerHTML = html;
      return template.content.firstChild;
    }



function search() {
    // clear existing results 
    existingResults = document.getElementById("results");
    while (existingResults.firstChild) {
      existingResults.removeChild(existingResults.firstChild);
    }
    
    // select values in search and filters 
    let query = '';
    let search_bar_value = document.querySelector('#search_bar').value;
    if (search_bar_value) {
      query += search_bar_value + '~1' //fuzzy search,  1 edit distance
    }
    let titles =  document.querySelector('#titles').value;
    if (!titles.length == 0) { 
      query += ' +id:' + titles;
    }
    let author=  document.querySelector('#author').value;
    if (!author.length == 0) { 
      query += ' +author_id:' + author;
    }
    let theater=  document.querySelector('#theater').value;
    if (!theater.length == 0) { 
      query += ' person_id:' + theater;
    }

    // Lunr query and populate results
    console.log('[query]', query)
    search_results = index.search(query)
    for (i in search_results) {
      if (search_results[i].score > 0) {
        //
        let ref_id = search_results[i].ref;
        let data = itemData[ref_id];
        console.log(data)
        document
            .querySelector("#results")
            .appendChild(
              htmlToElement(
                `<div onclick="showModal(${search_results[i].ref});" id="${search_results[i].ref}" style="border: 1px inset rgba(95,81,164,0.26); border-radius: 20px; padding:50px;">
                <div class="row">
                  <div class="col-lg-8 col-md-4">
                  <h4>${data['title']}</h4>
                  </div>
                  <div class="col-lg-2">
                  <h6>${data['year']}</h6>
                  </div>
                  <div class="col-lg-2">
                  <h6>${data['greg_full']}</h6>
                  </div>
                </div>
                </div>`
              )
            );

      }
      
    }
   
}; 

function search_bar() {
  // trigger search on enter from search bar
  if (event.keyCode === 13) { 
    search();
  }
}


 </script>
  {% endblock %}
